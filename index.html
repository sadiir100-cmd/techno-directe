<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Techno Direct â€” Vente PC</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --orange:#ff6600;
      --dark:#222;
      --light:#ffffff;
      --bg:#f4f4f6;
      --card-radius:12px;
      --max-width:1200px;
      --muted:#6b7280;
      --accent:#2d9cdb;
      --success:#10b981;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Cairo',sans-serif;
      background:var(--bg);
      color:var(--dark);
      -webkit-font-smoothing:antialiased;
    }

    /* HEADER */
    header{
      background:var(--orange);
      color:var(--light);
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:sticky;
      top:0;
      z-index:40;
      cursor:default;
      user-select:none;
    }
    .brand{display:flex;flex-direction:column;line-height:1}
    .brand h1{margin:0;font-size:20px;letter-spacing:0.5px}
    .brand span{font-size:13px;opacity:0.95}

    /* LAYOUT */
    .wrap{max-width:var(--max-width);margin:22px auto;padding:0 16px}
    #catalogue{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}

    /* CARDS */
    .card{
      background:var(--light);
      border-radius:var(--card-radius);
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      overflow:hidden;
      transition:transform .22s,box-shadow .22s;
      display:flex;
      flex-direction:column;
    }
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 30px rgba(0,0,0,0.08)}
    .card .media{height:190px;background:#eee;display:flex;align-items:center;justify-content:center}
    .card .media img{width:100%;height:100%;object-fit:cover}
    .card .content{padding:12px 14px;flex:1;display:flex;flex-direction:column}
    .card h3{margin:0;color:var(--orange);font-size:18px}
    .card p.desc{margin:8px 0 6px;font-size:13px;color:#333;line-height:1.2}
    .card p.spec{font-size:13px;color:#444;margin:4px 0}
    .card .price{margin-top:auto;font-weight:700;font-size:16px}

    /* thumbs & quantity */
    .thumbs-row{display:flex;gap:8px;padding:10px;justify-content:center;flex-wrap:wrap}
    .thumb{width:64px;height:46px;object-fit:cover;border-radius:8px;border:1px solid rgba(0,0,0,0.08);cursor:pointer}
    .thumb.active{outline:3px solid rgba(255,102,0,0.15)}
    .qty-row{display:flex;align-items:center;gap:8px;justify-content:center;margin-top:8px}
    .qty-btn{width:36px;height:36px;border-radius:8px;border:0;background:#eee;cursor:pointer;font-weight:700}
    .qty-display{min-width:44px;text-align:center;font-weight:700}

    .actions{display:flex;gap:8px;padding:10px;background:transparent}
    .actions button{flex:1;padding:10px;border:0;border-radius:8px;cursor:pointer;font-weight:700}
    .btn-commande{background:var(--orange);color:white}
    .btn-whatsapp{background:#25D366;color:white}
    /* .btn-edit removed per your request (blue button removed) */

    /* FOOTER */
    footer{background:var(--dark);color:white;padding:18px 10px;margin-top:30px}
    footer .wrap{display:flex;flex-direction:column;align-items:center;gap:6px}
    footer a{color:var(--orange);text-decoration:none;font-weight:700}

    /* POPUPS & MODALS */
    .overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1200;padding:20px}
    .modal{background:white;border-radius:10px;width:100%;max-width:720px;padding:16px;box-shadow:0 14px 40px rgba(0,0,0,0.3)}
    .modal h2{margin:0 0 8px;color:var(--orange)}
    .modal .field{margin:8px 0}
    .modal input[type="text"], .modal input[type="number"], .modal select, .modal textarea{
      width:100%;padding:9px;border-radius:8px;border:1px solid #ddd;font-size:14px
    }
    .modal textarea{min-height:86px;resize:vertical}
    .modal .row{display:flex;gap:8px}
    .modal .row .col{flex:1}
    .modal .actions{display:flex;gap:8px;margin-top:10px}
    .modal button{flex:1;padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn-save{background:var(--orange);color:white}
    .btn-cancel{background:#999;color:white}

    /* ADMIN PANEL FULL */
    #adminPanelFull{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1300;overflow:auto;padding:24px}
    #adminInner{background:#0f1720;color:white;border-radius:10px;padding:18px;max-width:1200px;margin:12px auto}
    #adminInner h2{color:var(--orange);margin-top:0}
    .admin-grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .admin-left{padding:8px}
    .admin-right{background:#0b1220;padding:12px;border-radius:8px}
    .btn-close-admin{background:var(--danger);border:0;padding:8px 12px;border-radius:8px;color:white;cursor:pointer}

    table{width:100%;border-collapse:collapse}
    table th, table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.06);font-size:13px;color:#e6eef8;text-align:left}
    .smallbtn{background:#334155;color:white;padding:6px 8px;border-radius:6px;border:0;cursor:pointer;margin-left:6px}

    /* responsive */
    @media (max-width:900px){
      .admin-grid{grid-template-columns:1fr}
      .card .media{height:160px}
    }

    /* small helpers */
    .hint{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header id="siteHeader" title="Double-clic pour admin (mot de passe)">
    <div class="brand">
      <h1>Techno Direct</h1>
      <span>Cartable gratuit + Garantie</span>
    </div>
    <div style="text-align:right;font-size:13px">
      <div>ðŸ“ž 0699039372 â€” 0560072059</div>
      <div style="margin-top:6px">Instagram: <a href="https://instagram.com/techno__direct" target="_blank">@techno__direct</a> | Facebook: <a href="https://facebook.com/technodirect" target="_blank">techno direct</a></div>
    </div>
  </header>

  <div class="wrap">
    <main id="catalogue"></main>
  </div>

  <footer>
    <div class="wrap">
      <div>ðŸ“ž 0699039372 | 0560072059</div>
      <div>Instagram: <a href="https://instagram.com/techno__direct" target="_blank">@techno__direct</a> â€” Facebook: <a href="https://facebook.com/technodirect" target="_blank">techno direct</a></div>
      <div style="margin-top:8px;font-size:13px;opacity:0.9">Â© 2025 Techno Direct â€” Tous droits rÃ©servÃ©s</div>
    </div>
  </footer>

  <!-- COMMANDE MODALE (PUBLIC) -->
  <div id="overlayCommande" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h2>Commander â€” <span id="modalProduitNom"></span></h2>
      <div class="field"><input id="cmd_nom" type="text" placeholder="Ton prÃ©nom et nom" /></div>
      <div class="field"><input id="cmd_tel" type="text" placeholder="NumÃ©ro principal" /></div>
      <div class="field"><input id="cmd_tel2" type="text" placeholder="NumÃ©ro secondaire (facultatif)" /></div>
      <div class="field">
        <select id="cmd_wilaya"><option value="">Choisir une wilaya</option></select>
      </div>
      <div class="field">
        <select id="cmd_type"><option value="Domicile">Livraison Ã  domicile</option><option value="Bureau">RÃ©cupÃ©ration au bureau</option></select>
      </div>
      <div class="field qty-field">
        <label style="display:block;margin-bottom:6px;font-weight:700">QuantitÃ©</label>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="qty-btn" id="cmd_minus">âˆ’</button>
          <div class="qty-display" id="cmd_qty">1</div>
          <button class="qty-btn" id="cmd_plus">+</button>
          <div style="margin-left:8px" id="cmd_total_price" class="hint"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-save" id="btn_submit_cmd">Commander</button>
        <button class="btn-cancel" id="btn_close_cmd">Fermer</button>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL (plein Ã©cran) -->
  <div id="adminPanelFull" aria-hidden="true">
    <div id="adminInner">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Zone Administrative â€” Techno Direct</h2>
        <div>
          <button class="btn-close-admin" onclick="closeAdminFull()">Fermer</button>
        </div>
      </div>

      <div class="admin-grid" id="adminGridRoot">
        <div class="admin-left" id="adminLeftColumn"></div>
        <div class="admin-right" id="adminRightColumn"></div>
      </div>
    </div>
  </div>
<script>
/* ========== PARTIE 2 ===========
   DonnÃ©es, utilitaires, initialisation
   ================================== */

const ADMIN_PWD = 'technoid';
const STORAGE_KEY_AFFICHES = 'td_affiches_v3';
const STORAGE_KEY_COMMANDES = 'td_commandes_v3';
const STORAGE_KEY_WILAYAS = 'td_prix_wilaya_v3';
const MAX_QTY = 20;

// Utilitaires
function genId(){ return 'id_'+Math.random().toString(36).slice(2,9) }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
function load(key, fallback){ try{ const r = localStorage.getItem(key); return r ? JSON.parse(r) : fallback }catch(e){ return fallback } }
function numberFormat(n){ if(n == null) return ''; return new Intl.NumberFormat('fr-FR').format(n) + ' DA' }
function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;') }
function downloadFile(content, filename, type='application/json'){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

// DEFAULT AFFICHES (seed, static)
const DEFAULT_AFFICHES = [
  { id: genId(), titre: "HP ZBook 14u G6", prix: 60000, description: "256 SSD â€¢ 8 Go RAM â€¢ Batterie >3h â€¢ Processeur i5", specs: "256 SSD Â· 8 Go Â· i5 Â· Batterie >3h", main: null, thumbs: [], createdAt: Date.now() },
  { id: genId(), titre: "Lenovo ThinkPad T480", prix: 72000, description: "512 SSD â€¢ 8 Go â€¢ Excellente autonomie", specs: "512 SSD Â· 8 Go Â· i5", main: null, thumbs: [], createdAt: Date.now() },
  { id: genId(), titre: "Dell Latitude 3310", prix: 65000, description: "256 SSD â€¢ 8 Go â€¢ Full HD", specs: "256 SSD Â· 8 Go Â· Full HD", main: null, thumbs: [], createdAt: Date.now() },
  { id: genId(), titre: "HP EliteBook 840 G3", prix: 58000, description: "256 SSD â€¢ 8 Go â€¢ LÃ©ger", specs: "256 SSD Â· 8 Go", main: null, thumbs: [], createdAt: Date.now() },
  { id: genId(), titre: "Lenovo IdeaPad 3", prix: 54000, description: "128 SSD â€¢ 4 Go â€¢ Bon prix", specs: "128 SSD Â· 4 Go", main: null, thumbs: [], createdAt: Date.now() },
];

// DEFAULT WILAYA PRICES â€” from your provided list
const DEFAULT_WILAYAS = {
  "Adrar":[1400,970],"Chlef":[800,520],"Laghouat":[950,620],"Oum El Bouaghi":[800,520],"Batna":[800,520],
  "Bejaia":[500,520],"Biskra":[950,620],"Bechar":[1100,720],"Blida":[750,470],"Bouira":[700,520],
  "Tamanrasset":[1600,1120],"Tebessa":[800,520],"Tlemcen":[900,570],"Tiaret":[800,520],"Tizi Ouzou":[650,520],
  "Alger":[600,470],"Djelfa":[950,620],"Jijel":[700,520],"SÃ©tif":[750,520],"Saida":[800,570],
  "Skikda":[750,520],"Sidi Bel AbbÃ¨s":[750,520],"Annaba":[800,520],"Guelma":[800,520],"Constantine":[750,520],
  "Medea":[750,520],"Mostaganem":[750,520],"M'Sila":[850,570],"Mascara":[750,520],"Ouargla":[1000,670],
  "Oran":[700,520],"El Bayadh":[1050,670],"Illizi":[0,0],"Bordj Bou Arreridj":[750,520],"Boumerdes":[750,520],
  "El Tart":[850,520],"Tindouf":[0,0],"Tissemsilt":[800,520],"El Oued":[1000,670],"Khenchela":[800,0],
  "Souk Ahras":[800,520],"Tipaza":[750,520],"Mila":[750,520],"Ain Defla":[750,520],"Naama":[1100,670],
  "Ain Temouchent":[750,520],"Ghardaia":[1000,620],"Relizane":[750,520],"Timimoun":[1400,0],"Bordj Badji Mokhtar":[0,0],
  "Ouled Djellal":[950,620],"BÃ©ni AbbÃ¨s":[1000,970],"In Salah":[1600,0],"In Guezzam":[1600,0],"Touggourt":[1000,670],
  "Djanet":[0,0],"M'Ghair":[1000,0],"Meniaa":[1000,0]
};

// Load / initialize app data (keep existing localStorage if present)
let affiches = load(STORAGE_KEY_AFFICHES, DEFAULT_AFFICHES.slice());
let commandes = load(STORAGE_KEY_COMMANDES, []);
let prixParWilaya = load(STORAGE_KEY_WILAYAS, DEFAULT_WILAYAS);

// Normalize affiches: ensure thumbs is array and main exists (or null)
affiches = (affiches || []).map(a => ({
  ...a,
  thumbs: Array.isArray(a.thumbs) ? a.thumbs : [],
  main: (a.main || a.image) ? (a.main || a.image) : null
}));

// Save helpers
function persistAll(){ save(STORAGE_KEY_AFFICHES, affiches); save(STORAGE_KEY_COMMANDES, commandes); save(STORAGE_KEY_WILAYAS, prixParWilaya); }

// small log
console.log('Techno Direct â€” script initialisÃ©. Admin pwd:', ADMIN_PWD);
</script>
<script>
/* ========== PARTIE 3 ===========
   Rendu public : catalogue, quantitÃ©, lightbox, wilayas
   ================================== */

function renderCatalogue(){
  const root = document.getElementById('catalogue');
  root.innerHTML = '';
  affiches.forEach((pc, idx) => {
    const mainSrc = pc.main || (pc.thumbs && pc.thumbs[0]) || 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=900&q=60';
    const card = document.createElement('article');
    card.className = 'card';
    card.dataset.id = pc.id;
    card.innerHTML = `
      <div class="media"><img src="${escapeHtml(mainSrc)}" alt="${escapeHtml(pc.titre)}" loading="lazy"></div>
      <div class="content">
        <h3>${escapeHtml(pc.titre)}</h3>
        <p class="desc">${escapeHtml(pc.description||'')}</p>
        <p class="spec">${escapeHtml(pc.specs||'')}</p>
        <div class="price" id="price_${pc.id}">${numberFormat(pc.prix)}</div>

        <div class="thumbs-row" id="thumbs_${pc.id}"></div>

        <div class="qty-row" style="margin-top:8px" id="qtyRow_${pc.id}">
          <button class="qty-btn" data-action="minus" aria-label="RÃ©duire la quantitÃ©">âˆ’</button>
          <div class="qty-display" id="qty_${pc.id}">1</div>
          <button class="qty-btn" data-action="plus" aria-label="Augmenter la quantitÃ©">+</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn-commande" data-id="${pc.id}">Commander</button>
        <button class="btn-whatsapp" data-wh="${encodeURIComponent(pc.titre)}">WhatsApp</button>
      </div>
    `;
    // append thumbs if any (up to 4)
    const thumbWrap = card.querySelector(`#thumbs_${pc.id}`);
    (pc.thumbs || []).slice(0,4).forEach((t,i)=>{
      const im = document.createElement('img');
      im.src = t;
      im.className = 'thumb' + (i===0 ? ' active' : '');
      im.alt = `mini-${i+1}`;
      im.onclick = () => {
        const imgMain = card.querySelector('.media img');
        imgMain.src = t;
        // mark active
        thumbWrap.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active'));
        im.classList.add('active');
      };
      thumbWrap.appendChild(im);
    });

    // quantity logic
    const qtyDisplay = card.querySelector(`#qty_${pc.id}`);
    const priceDiv = card.querySelector(`#price_${pc.id}`);
    let qty = 1;
    function updateQty(delta){
      qty = Math.max(1, Math.min(MAX_QTY, qty + delta));
      qtyDisplay.textContent = qty;
      priceDiv.textContent = numberFormat((pc.prix||0) * qty);
    }
    card.querySelector('[data-action="minus"]').onclick = ()=> updateQty(-1);
    card.querySelector('[data-action="plus"]').onclick = ()=> updateQty(1);

    // order & whatsapp
    card.querySelector('.btn-commande').onclick = (e)=> {
      openCommandeModal(pc.id, qty);
    };
    card.querySelector('.btn-whatsapp').onclick = (e)=> {
      const txt = `Salam, je veux commander ${pc.titre} (${qty} piÃ¨ce(s))`;
      const url = `https://wa.me/213699039372?text=${encodeURIComponent(txt)}`;
      window.open(url, '_blank');
    };

    // lightbox on main image click
    card.querySelector('.media img').onclick = (e)=> openLightbox(e.currentTarget.src, pc);

    root.appendChild(card);
  });
}

/* LIGHTBOX with download + thumbnails navigation */
let lbEl = null;
function openLightbox(src, product){
  closeLightbox();
  lbEl = document.createElement('div'); lbEl.className = 'overlay'; lbEl.style.display='flex';
  const thumbsHtml = (product.thumbs || []).slice(0,4).map(t=>`<img src="${t}" style="width:64px;height:48px;object-fit:cover;border-radius:6px;margin-right:6px;cursor:pointer">`).join('');
  lbEl.innerHTML = `<div class="modal" style="max-width:920px">
    <h2 style="margin-top:0">${escapeHtml(product.titre || '')}</h2>
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1"><img src="${escapeHtml(src)}" style="width:100%;height:auto;border-radius:8px" id="lb_main_img"></div>
      <div style="width:220px">
        <div style="margin-bottom:8px;font-weight:700">Miniatures</div>
        <div>${thumbsHtml || '<div class="hint">Aucune miniature</div>'}</div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="lb_download" class="btn-save">TÃ©lÃ©charger</button>
          <button id="lb_close" class="btn-cancel">Fermer</button>
        </div>
      </div>
    </div>
  </div>`;
  document.body.appendChild(lbEl);
  // wire thumbnails inside lightbox
  Array.from(lbEl.querySelectorAll('img')).forEach(img=>{
    img.onclick = ()=> {
      const main = lbEl.querySelector('#lb_main_img');
      main.src = img.src;
    };
  });
  lbEl.querySelector('#lb_close').onclick = closeLightbox;
  lbEl.querySelector('#lb_download').onclick = ()=> downloadFile(fetchImageAsBlob(lbEl.querySelector('#lb_main_img').src), (product.titre||'image') + '.jpg', 'image/jpeg');
  lbEl.onclick = (e)=> { if(e.target === lbEl) closeLightbox(); }
}
function closeLightbox(){ if(lbEl){ lbEl.remove(); lbEl = null; } }
// helper to download image blob by URL (works for dataURL or CORS-allowed)
async function fetchImageAsBlob(url){
  try{
    if(url.startsWith('data:')) return url;
    const res = await fetch(url, {mode:'cors'}); const blob = await res.blob();
    return blob;
  }catch(e){
    return url;
  }
}

/* Open commande modal from public card - preserve qty */
let currentOrder = { productId:null, qty:1 };
function openCommandeModal(productId, qty=1){
  currentOrder.productId = productId;
  currentOrder.qty = qty || 1;
  const pc = affiches.find(a=>a.id===productId);
  if(!pc) return alert('Produit introuvable');
  document.getElementById('modalProduitNom').innerText = pc.titre;
  document.getElementById('cmd_qty').innerText = currentOrder.qty;
  document.getElementById('overlayCommande').style.display = 'flex';
  document.getElementById('overlayCommande').setAttribute('aria-hidden','false');
  fillWilayaSelect('cmd_wilaya');
  updateCommandeTotalDisplay();
}
document.getElementById('btn_close_cmd').onclick = ()=> {
  document.getElementById('overlayCommande').style.display='none';
  document.getElementById('overlayCommande').setAttribute('aria-hidden','true');
};
// qty inside modal
document.getElementById('cmd_minus').onclick = ()=> { currentOrder.qty = Math.max(1, currentOrder.qty -1); document.getElementById('cmd_qty').innerText = currentOrder.qty; updateCommandeTotalDisplay(); }
document.getElementById('cmd_plus').onclick = ()=> { currentOrder.qty = Math.min(MAX_QTY, currentOrder.qty +1); document.getElementById('cmd_qty').innerText = currentOrder.qty; updateCommandeTotalDisplay(); }

function updateCommandeTotalDisplay(){
  const pc = affiches.find(a=>a.id===currentOrder.productId);
  if(!pc) return;
  const wilaya = document.getElementById('cmd_wilaya').value || '';
  const mode = document.getElementById('cmd_type').value || 'Domicile';
  const liv = (prixParWilaya[wilaya] && prixParWilaya[wilaya][ mode==='Domicile' ? 0 : 1 ]) || 0;
  const total = (pc.prix || 0) * currentOrder.qty + (liv || 0);
  document.getElementById('cmd_total_price').innerText = 'Total: ' + numberFormat(total);
}
document.getElementById('cmd_wilaya').onchange = updateCommandeTotalDisplay;
document.getElementById('cmd_type').onchange = updateCommandeTotalDisplay;
document.getElementById('btn_submit_cmd').onclick = ()=> {
  const nom = document.getElementById('cmd_nom').value.trim();
  const tel = document.getElementById('cmd_tel').value.trim();
  const tel2 = document.getElementById('cmd_tel2').value.trim();
  const wilaya = document.getElementById('cmd_wilaya').value;
  const type = document.getElementById('cmd_type').value;
  if(!nom || !tel || !wilaya) return alert('Remplis les champs obligatoires (nom, tÃ©lÃ©phone, wilaya).');
  const pc = affiches.find(a=>a.id===currentOrder.productId);
  if(!pc) return alert('Produit introuvable.');
  const livInfo = prixParWilaya[wilaya] || [0,0];
  const prixLiv = type === 'Domicile' ? livInfo[0] : livInfo[1];
  const total = (pc.prix || 0) * currentOrder.qty + (prixLiv || 0);
  const cmd = { id: genId(), produit: pc.titre, produitId: pc.id, nom, tel, tel2, wilaya, type, qty: currentOrder.qty, prixProduit: pc.prix, prixLivraison: prixLiv, total, date: new Date().toISOString() };
  commandes.push(cmd);
  persistAll();
  alert('âœ… Commande enregistrÃ©e ! Nous vous contacterons.');
  document.getElementById('overlayCommande').style.display='none';
  document.getElementById('overlayCommande').setAttribute('aria-hidden','true');
  // optionally open admin or notify
}
</script>
<script>
/* ========== PARTIE 4 ===========
   Admin trigger + Admin UI + upload thumbs (up to 4) + Wilaya editor
   ================================== */
// Hidden trigger: double-click top-left area (we reuse header click area)
let lastClick = 0;
document.getElementById('siteHeader').addEventListener('dblclick', promptAdminLogin);
document.getElementById('siteHeader').addEventListener('click', (e)=> {
  const now = Date.now();
  if(now - lastClick < 420) promptAdminLogin();
  lastClick = now;
});
function promptAdminLogin(){
  const pwd = prompt('Mot de passe admin :');
  if(pwd === ADMIN_PWD){
    openAdminFull();
  } else {
    alert('Mot de passe incorrect');
  }
}
// Build admin UI (injected)
function openAdminFull(){
  document.getElementById('adminPanelFull').style.display = 'block';
  document.getElementById('adminPanelFull').setAttribute('aria-hidden','false');
  buildAdminUI();
}
function closeAdminFull(){
  document.getElementById('adminPanelFull').style.display = 'none';
  document.getElementById('adminPanelFull').setAttribute('aria-hidden','true');
  persistAll();
}
// Build admin columns
function buildAdminUI(){
  const left = document.getElementById('adminLeftColumn');
  const right = document.getElementById('adminRightColumn');
  left.innerHTML = '';
  right.innerHTML = '';
  // LEFT: form for add/edit + affiches list
  left.innerHTML = `
    <section style="background:#071022;padding:12px;border-radius:8px;margin-bottom:12px">
      <h3 style="margin:0 0 8px;color:var(--orange)">Ajouter / Modifier une affiche</h3>
      <div style="display:grid;gap:8px">
        <input id="adm_titre" placeholder="Nom du PC" />
        <input id="adm_prix" type="number" placeholder="Prix (DA)" />
        <input id="adm_specs" placeholder="SpÃ©cifications courtes" />
        <textarea id="adm_desc" placeholder="Description dÃ©taillÃ©e"></textarea>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="adm_main_file" type="file" accept="image/*" />
          <button class="smallbtn" id="adm_upload_main_btn">TÃ©lÃ©charger image principale</button>
          <button class="smallbtn" id="adm_clear_main_btn">Effacer</button>
        </div>
        <div>
          <label style="font-weight:700">Images secondaires (max 4)</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="adm_thumb_file_0" type="file" accept="image/*" />
            <input id="adm_thumb_file_1" type="file" accept="image/*" />
            <input id="adm_thumb_file_2" type="file" accept="image/*" />
            <input id="adm_thumb_file_3" type="file" accept="image/*" />
          </div>
          <div style="margin-top:8px" id="adm_thumbs_preview"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn-save" id="adm_save_affiche">ðŸ’¾ Sauvegarder</button>
          <button class="btn-cancel" id="adm_cancel_edit">Annuler</button>
        </div>
      </div>
    </section>
    <section style="background:#071022;padding:12px;border-radius:8px">
      <h3 style="margin:0 0 8px;color:var(--orange)">Affiches publiÃ©es (${affiches.length})</h3>
      <div id="adm_list_affiches" style="max-height:420px;overflow:auto"></div>
    </section>
  `;
  // RIGHT: commandes + wilayas + tools
  right.innerHTML = `
    <section style="margin-bottom:12px">
      <h3 style="color:var(--orange)">Commandes reÃ§ues (${commandes.length})</h3>
      <div style="max-height:260px;overflow:auto;background:#081224;padding:8px;border-radius:8px">
        <table id="adm_table_cmds" style="width:100%"></table>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="smallbtn" id="adm_export_cmds">Exporter CSV</button>
        <button class="smallbtn" id="adm_delete_all_cmds">Supprimer tout</button>
      </div>
    </section>
    <section style="margin-top:12px;background:#071022;padding:10px;border-radius:8px">
      <h3 style="color:var(--orange)">Prix livraison â€” Wilayas</h3>
      <div id="adm_prix_wilaya" style="max-height:360px;overflow:auto;padding-top:8px"></div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn-save" id="adm_save_wilayas">ðŸ’¾ Sauvegarder prix</button>
        <button class="btn-cancel" id="adm_reset_wilayas">RÃ©initialiser</button>
      </div>
    </section>
    <section style="margin-top:12px;background:#071022;padding:10px;border-radius:8px">
      <h3 style="color:var(--orange)">Outils</h3>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <button class="smallbtn" id="adm_export_all">Exporter tout (JSON)</button>
        <button class="smallbtn" id="adm_import_all">Importer JSON</button>
        <button class="smallbtn" id="adm_download_wilayas_csv">TÃ©lÃ©charger CSV wilayas</button>
      </div>
    </section>
  `;
  // wire admin controls
  wireAdminControls();
  renderAdminAffichesList();
  renderAdminCommandsTable();
  renderAdminPrixWilaya();
}
// Wire admin behaviors (uploads, save, list)
let editingIdx = -1;
function wireAdminControls(){
  // main image upload button
  const mainFile = document.getElementById('adm_main_file');
  document.getElementById('adm_upload_main_btn').onclick = ()=> mainFile.click();
  mainFile.onchange = (e)=> {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      const src = r.result;
      const preview = document.getElementById('adm_thumbs_preview');
      // clear previous main-preview if any
      Array.from(preview.querySelectorAll('[data-main-preview]')).forEach(n=>n.closest('div').remove());
      preview.insertAdjacentHTML('beforeend', `<div style="display:inline-block;width:120px;margin-right:8px"><img src="${src}" style="width:100%;border-radius:6px" data-main-preview /></div>`);
      // temporarily store in a data attr for saving when Save clicked
      // store explicit string (could be empty string to clear)
      preview.dataset.mainTemp = src;
    };
    r.readAsDataURL(f);
  };
  document.getElementById('adm_clear_main_btn').onclick = ()=> {
    const preview = document.getElementById('adm_thumbs_preview');
    // indicate explicit clearing by setting dataset to empty string
    preview.dataset.mainTemp = ''; // explicit "empty" to remove main when saving
    Array.from(preview.querySelectorAll('[data-main-preview]')).forEach(n=>n.closest('div').remove());
  };
  // thumbs uploads (up to 4)
  for(let i=0;i<4;i++){
    const inp = document.getElementById('adm_thumb_file_'+i);
    inp.onchange = (e)=> {
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=> {
        const src = r.result;
        // append preview
        const preview = document.getElementById('adm_thumbs_preview');
        const div = document.createElement('div'); div.style.display='inline-block'; div.style.marginRight='8px';
        div.innerHTML = `<img src="${src}" style="width:120px;border-radius:6px"><div style="text-align:center;font-size:12px">mini ${i+1}</div>`;
        preview.appendChild(div);
        // store temporaries in dataset thumbsTemp as JSON array
        const temp = preview.dataset.thumbsTemp ? JSON.parse(preview.dataset.thumbsTemp) : [];
        temp[i] = src;
        preview.dataset.thumbsTemp = JSON.stringify(temp);
      };
      r.readAsDataURL(f);
    };
  }
  // Save affiche
  document.getElementById('adm_save_affiche').onclick = ()=> {
    const titre = document.getElementById('adm_titre').value.trim();
    const prix = parseInt(document.getElementById('adm_prix').value) || 0;
    const specs = document.getElementById('adm_specs').value.trim();
    const desc = document.getElementById('adm_desc').value.trim();
    const preview = document.getElementById('adm_thumbs_preview');
    // note: preview.dataset.mainTemp can be undefined (no change), '' (explicit clear), or dataURL
    const mainTempExists = Object.prototype.hasOwnProperty.call(preview.dataset, 'mainTemp');
    const mainTemp = mainTempExists ? preview.dataset.mainTemp : undefined;
    const thumbsTemp = preview.dataset.thumbsTemp ? JSON.parse(preview.dataset.thumbsTemp) : [];
    if(!titre || !prix || !desc){ alert('Nom, prix et description obligatoires.'); return; }
    if(editingIdx >= 0){
      // update existing
      affiches[editingIdx].titre = titre;
      affiches[editingIdx].prix = prix;
      affiches[editingIdx].specs = specs;
      affiches[editingIdx].description = desc;
      // mainTemp handling: if undefined -> keep existing; if '' -> clear; if dataURL -> set
      if(mainTemp !== undefined){
        affiches[editingIdx].main = mainTemp ? mainTemp : null;
      }
      // merge thumbs: keep existing, overwrite with new ones when provided
      const existing = affiches[editingIdx].thumbs || [];
      const merged = [];
      for(let i=0;i<4;i++){
        // thumbsTemp may be sparse; prefer thumbsTemp[i] when present and truthy
        merged[i] = (thumbsTemp && typeof thumbsTemp[i] !== 'undefined' && thumbsTemp[i]) ? thumbsTemp[i] : existing[i] || null;
      }
      affiches[editingIdx].thumbs = merged.filter(Boolean);
      alert('Affiche modifiÃ©e.');
    } else {
      // add new (limit 20)
      if(affiches.length >= 20){ alert('Limite : max 20 affiches.'); return; }
      const newAff = { id: genId(), titre, prix, specs, description: desc, main: (mainTemp ? mainTemp : null), thumbs: (thumbsTemp || []).filter(Boolean), createdAt: Date.now() };
      affiches.unshift(newAff);
      alert('Nouvelle affiche ajoutÃ©e.');
    }
    // cleanup temp previews
    delete preview.dataset.mainTemp;
    delete preview.dataset.thumbsTemp;
    preview.innerHTML = '';
    clearAdminForm();
    persistAll();
    renderAdminAffichesList();
    renderCatalogue(); // update public immediately
  };
  document.getElementById('adm_cancel_edit').onclick = ()=> { clearAdminForm(); editingIdx = -1; };
  // exports & imports
  document.getElementById('adm_export_all').onclick = ()=> {
    const data = { affiches, commandes, prixParWilaya };
    downloadFile(JSON.stringify(data,null,2), 'techno_direct_export.json', 'application/json');
  };
  document.getElementById('adm_import_all').onclick = ()=> {
    const input = document.createElement('input'); input.type='file'; input.accept='.json,application/json';
    input.onchange = e=> {
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = ()=> {
        try{
          const obj = JSON.parse(r.result);
          if(obj.affiches) affiches = obj.affiches;
          if(obj.commandes) commandes = obj.commandes;
          if(obj.prixParWilaya) prixParWilaya = obj.prixParWilaya;
          // normalize after import
          affiches = (affiches || []).map(a => ({ ...a, thumbs: Array.isArray(a.thumbs)?a.thumbs:[], main: (a.main||a.image) ? (a.main||a.image) : null }));
          persistAll(); renderAdminAffichesList(); renderAdminCommandsTable(); renderAdminPrixWilaya(); renderCatalogue();
          alert('Import OK');
        }catch(err){ alert('Fichier JSON invalide'); }
      }; r.readAsText(f);
    }; input.click();
  };
  document.getElementById('adm_export_cmds').onclick = ()=> {
    if(commandes.length === 0) return alert('Aucune commande');
    // CSV
    const rows = [['id','produit','nom','tel','tel2','wilaya','type','qty','prixProduit','prixLivraison','total','date']];
    commandes.forEach(c => rows.push([c.id, c.produit, c.nom, c.tel, c.tel2||'', c.wilaya, c.type, c.qty||1, c.prixProduit||0, c.prixLivraison||0, c.total||0, c.date||'']));
    const csv = rows.map(r => r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadFile(csv, 'commandes_techno_direct.csv', 'text/csv');
  };
  document.getElementById('adm_delete_all_cmds').onclick = ()=> {
    if(!confirm('Supprimer toutes les commandes ?')) return;
    commandes = []; persistAll(); renderAdminCommandsTable();
  };
  // wilaya save/reset
  document.getElementById('adm_save_wilayas').onclick = ()=> { persistAll(); alert('Prix sauvegardÃ©s'); };
  document.getElementById('adm_reset_wilayas').onclick = ()=> {
    if(!confirm('RÃ©initialiser aux valeurs par dÃ©faut ?')) return;
    prixParWilaya = JSON.parse(JSON.stringify(DEFAULT_WILAYAS));
    persistAll(); renderAdminPrixWilaya();
  };
  document.getElementById('adm_download_wilayas_csv').onclick = ()=> {
    const rows = [['Wilaya','Domicile','Stopdesk']];
    for(const w in prixParWilaya) rows.push([w, prixParWilaya[w][0], prixParWilaya[w][1]]);
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadFile(csv, 'wilayas_prices.csv', 'text/csv');
  };
}
// Render admin affiches list (left column)
function renderAdminAffichesList(){
  const wrap = document.getElementById('adm_list_affiches');
  wrap.innerHTML = '';
  affiches.forEach((a, idx)=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center';
    div.style.padding='8px'; div.style.background='#071526'; div.style.borderRadius='6px'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
      <div style="width:72px;height:52px;overflow:hidden;border-radius:6px"><img src="${a.main || (a.thumbs&&a.thumbs[0]) || ''}" style="width:100%;height:100%;object-fit:cover"></div>
      <div><div style="font-weight:700;color:var(--orange)">${escapeHtml(a.titre)}</div><div class="small">${numberFormat(a.prix)}</div></div>
    </div>
    <div>
      <button class="smallbtn" onclick="startEditAffiche(${idx})">Modifier</button>
      <button class="smallbtn" onclick="moveAfficheUp(${idx})">â†‘</button>
      <button class="smallbtn" onclick="moveAfficheDown(${idx})">â†“</button>
      <button class="smallbtn" style="background:${'var(--danger)'}" onclick="deleteAffiche(${idx})">Suppr</button>
    </div>`;
    wrap.appendChild(div);
  });
}
// start edit
function startEditAffiche(idx){
  editingIdx = idx;
  const a = affiches[idx];
  document.getElementById('adm_titre').value = a.titre || '';
  document.getElementById('adm_prix').value = a.prix || '';
  document.getElementById('adm_specs').value = a.specs || '';
  document.getElementById('adm_desc').value = a.description || '';
  // preview main and thumbs
  const preview = document.getElementById('adm_thumbs_preview');
  preview.innerHTML = '';
  // ensure dataset cleared
  delete preview.dataset.mainTemp;
  delete preview.dataset.thumbsTemp;
  if(a.main) preview.insertAdjacentHTML('beforeend', `<div style="display:inline-block;width:120px;margin-right:8px"><img src="${a.main}" style="width:100%;border-radius:6px" data-main-preview /></div>`);
  if(a.thumbs && a.thumbs.length){
    a.thumbs.slice(0,4).forEach((t,i)=> preview.insertAdjacentHTML('beforeend', `<div style="display:inline-block;width:120px;margin-right:8px"><img src="${t}" style="width:100%;border-radius:6px"><div style="text-align:center;font-size:12px">mini ${i+1}</div></div>`));
    preview.dataset.thumbsTemp = JSON.stringify(a.thumbs.slice(0,4));
  }
}
</script>
<script>
// delete, move functions
function deleteAffiche(idx){ if(!confirm('Supprimer cette affiche ?')) return; affiches.splice(idx,1); persistAll(); renderAdminAffichesList(); renderCatalogue(); }
function moveAfficheUp(idx){ if(idx<=0) return; [affiches[idx-1], affiches[idx]] = [affiches[idx], affiches[idx-1]]; persistAll(); renderAdminAffichesList(); renderCatalogue(); }
function moveAfficheDown(idx){ if(idx>=affiches.length-1) return; [affiches[idx+1], affiches[idx]] = [affiches[idx], affiches[idx+1]]; persistAll(); renderAdminAffichesList(); renderCatalogue(); }
// clear admin form
function clearAdminForm(){ editingIdx = -1; document.getElementById('adm_titre').value=''; document.getElementById('adm_prix').value=''; document.getElementById('adm_specs').value=''; document.getElementById('adm_desc').value=''; document.getElementById('adm_thumbs_preview').innerHTML=''; document.getElementById('adm_main_file').value=''; for(let i=0;i<4;i++) document.getElementById('adm_thumb_file_'+i).value=''; }
// Commandes table rendering
function renderAdminCommandsTable(){
  const table = document.getElementById('adm_table_cmds');
  if(!table) return;
  if(commandes.length===0){ table.innerHTML = '<tr><td>Aucune commande</td></tr>'; return; }
  let html = '<tr><th>Produit</th><th>Nom</th><th>TÃ©l</th><th>Wilaya</th><th>Type</th><th>Total</th><th>Actions</th></tr>';
  commandes.forEach((c,i)=> {
    html += `<tr>
      <td>${escapeHtml(c.produit)}</td>
      <td>${escapeHtml(c.nom)}</td>
      <td>${escapeHtml(c.tel || '')}${c.tel2? ' / ' + escapeHtml(c.tel2): ''}</td>
      <td>${escapeHtml(c.wilaya)}</td>
      <td>${escapeHtml(c.type)}</td>
      <td>${numberFormat(c.total)}</td>
      <td><button class="smallbtn" onclick="openCommandWhatsApp(${i})">WhatsApp</button> <button class="smallbtn" onclick="deleteCommand(${i})" style="background:${'var(--danger)'}">Suppr</button></td>
    </tr>`;
  });
  table.innerHTML = html;
}
function openCommandWhatsApp(i){ const c = commandes[i]; if(!c) return; const msg = encodeURIComponent(`Commande ${c.produit}\nNom:${c.nom}\nTel:${c.tel}\nWilaya:${c.wilaya}\nTotal:${c.total}DA`); window.open(`https://wa.me/213699039372?text=${msg}`, '_blank'); }
function deleteCommand(i){ if(!confirm('Supprimer cette commande ?')) return; commandes.splice(i,1); persistAll(); renderAdminCommandsTable(); }
// Render wilaya editor (right column)
function renderAdminPrixWilaya(){
  const root = document.getElementById('adm_prix_wilaya');
  root.innerHTML = '';
  const keys = Object.keys(prixParWilaya).sort();
  keys.forEach(w=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0';
    const val = prixParWilaya[w] || [0,0];
    row.innerHTML = `<div style="width:60%">${escapeHtml(w)}</div>
      <div style="width:38%"><input type="number" value="${val[0]||0}" data-w="${escapeHtml(w)}" data-mode="home" style="width:80px"/> <input type="number" value="${val[1]||0}" data-w="${escapeHtml(w)}" data-mode="office" style="width:80px;margin-left:6px"/></div>`;
    root.appendChild(row);
  });
  // bind change events
  root.querySelectorAll('input[type="number"]').forEach(inp=>{
    inp.onchange = function(){
      const w = this.dataset.w;
      const mode = this.dataset.mode;
      const v = parseInt(this.value) || 0;
      if(!prixParWilaya[w]) prixParWilaya[w] = [0,0];
      prixParWilaya[w] = mode==='home' ? [v, prixParWilaya[w][1]||0] : [prixParWilaya[w][0]||0, v];
    };
  });
}
</script>
<script>
/* ========== PARTIE 5 ===========
   Final init: bind public buttons, populate wilaya selects, save/load, render
   ================================== */
// helper to fill wilaya select(s)
function fillWilayaSelect(selectId){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  sel.innerHTML = '<option value="">-- Choisir une wilaya --</option>';
  Object.keys(prixParWilaya).sort().forEach(w=>{
    sel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(w)}">${escapeHtml(w)}</option>`);
  });
}
// Delete command helper used in admin table (already declared earlier) - ensure accessible
window.deleteCommand = deleteCommand;
window.openCommandWhatsApp = openCommandWhatsApp;
// initialize UI
window.addEventListener('load', ()=>{
  // ensure prixParWilaya existence
  if(!prixParWilaya || Object.keys(prixParWilaya).length === 0){ prixParWilaya = JSON.parse(JSON.stringify(DEFAULT_WILAYAS)); save(STORAGE_KEY_WILAYAS, prixParWilaya); }
  // persist affiches & commandes to use unified keys (ensures localStorage keys created)
  persistAll();
  // fill selects
  fillWilayaSelect('cmd_wilaya');
  // initial render
  renderCatalogue();
});
// expose some functions for console quick usage
window.Technoid = {
  renderCatalogue,
  openAdminFull,
  persistAll,
  downloadCurrentExport: ()=> downloadFile(JSON.stringify({affiches, commandes, prixParWilaya}, null, 2), 'techno_direct_export.json'),
};
// small accessibility: Enter on header triggers admin login prompt if Ctrl/Meta+A pressed
window.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='a'){ e.preventDefault(); promptAdminLogin(); }
});
// comments:
// - Les images uploadÃ©es deviennent DataURL et sont stockÃ©es dans localStorage (attention Ã  la taille).
// - Wilayas et affiches sont sauvegardÃ©s automatiquement via persistAll().
// - J'ai gardÃ© toute l'UI inchangÃ©e et corrigÃ© la logique de sauvegarde pour que les modifications (titre, prix, description, specs, photo principale, miniatures) apparaissent immÃ©diatement sur le site public.
</script>
</body>
</html>
