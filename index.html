<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Techno Direct ‚Äì Vente PC Portables</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif}
    body{background:#f8f8f8;color:#333;overflow-x:hidden}
    header{background:#ff6b00;color:#fff;text-align:center;padding:20px 0;font-size:24px;font-weight:700;position:sticky;top:0;z-index:99}
    header span{font-weight:400;font-size:18px}
    #affichesContainer{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;padding:20px}
    .card{background:#fff;width:300px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1);overflow:hidden;transition:.3s}
    .card:hover{transform:translateY(-5px)}
    .card img{width:100%;height:180px;object-fit:cover}
    .info{padding:15px}
    .info h3{color:#ff6b00;margin-bottom:8px}
    .info p{margin-bottom:6px;font-size:15px}
    .buttons{display:flex;gap:10px;margin-top:10px}
    .buttons button{flex:1;padding:8px;border:none;border-radius:6px;cursor:pointer;font-weight:600}
    .buttons button:first-child{background:#ff6b00;color:#fff}
    .buttons .whatsapp{background:#25D366;color:#fff}
    footer{background:#222;color:#fff;text-align:center;padding:20px;margin-top:30px}
    footer p{margin:5px 0}
    footer a{color:#ff6b00;text-decoration:none}
    /* ----------- Formulaire commande popup ----------- */
    .form-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:200}
    .form-content{background:#fff;padding:25px;border-radius:10px;width:90%;max-width:400px;box-shadow:0 0 15px rgba(0,0,0,0.2)}
    .form-content h2{color:#ff6b00;text-align:center;margin-bottom:15px}
    .form-content input,.form-content select{width:100%;padding:10px;margin-bottom:10px;border:1px solid #ccc;border-radius:6px}
    .form-content button{width:100%;padding:10px;margin-top:5px;border:none;border-radius:6px;background:#ff6b00;color:#fff;font-weight:700;cursor:pointer}
    .form-content button:last-child{background:#ccc;color:#000}
    .total-prix{font-weight:700;color:#ff6b00;text-align:center;margin:8px 0}
    /* ----------- Zone Admin cach√©e ----------- */
    #adminPanel{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;overflow-y:auto;z-index:300;padding:20px}
    #adminPanel h2{color:#ff6b00;text-align:center;margin-bottom:10px}
    .admin-section{background:#f1f1f1;margin:15px 0;padding:15px;border-radius:8px}
    .admin-affiche{background:#fff;padding:10px;border-radius:6px;margin-bottom:10px;box-shadow:0 0 5px rgba(0,0,0,0.1)}
    .admin-affiche input,.admin-affiche textarea{width:100%;margin-bottom:6px;padding:8px;border:1px solid #ccc;border-radius:6px}
    .admin-affiche button{background:#ff6b00;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .admin-controls{text-align:center;margin-top:10px}
    .admin-controls button{margin:5px;padding:10px 20px;border:none;border-radius:6px;font-weight:700;cursor:pointer}
    .admin-controls .add{background:#25D366;color:#fff}
    .admin-controls .save{background:#ff6b00;color:#fff}
    .admin-controls .free{background:#007BFF;color:#fff}
    .admin-controls .deleteAll{background:#b30000;color:#fff}
    .livraison-gratuite{color:#25D366;font-weight:700}
  </style>
</head>

<body>
  <header>Techno Direct ‚Äì Cartable gratuit + Garantie originale</header>

  <!-- ======== Zone publique des affiches ======== -->
  <div id="affichesContainer">
    <div class="card">
      <img src="https://images.unsplash.com/photo-1509395176047-4a66953fd231?auto=format&fit=crop&w=800&q=60" alt="PC">
      <div class="info">
        <h3>HP ZBook 14u G6</h3>
        <p>Intel i7 8·µâ G√©n | 8 GigaOKT | 256 SSD | 14 pouces Full HD</p>
        <p><strong>Prix :</strong> 60 000 DA</p>
        <p><strong>Livraison :</strong> Selon la wilaya</p>
        <div class="buttons">
          <button onclick="ouvrirCommande(0)">Commander ici</button>
          <a href="https://wa.me/213699039372?text=Bonjour%2C%20je%20veux%20commander%20le%20HP%20ZBook%2014u%20G6" target="_blank">
            <button class="whatsapp">Commande WhatsApp</button>
          </a>
        </div>
      </div>
    </div>
    <!-- les autres cartes seront ajout√©es via admin -->
  </div>

  <!-- ======== Zone admin cach√©e (apparait avec mot de passe) ======== -->
  <div id="adminPanel">
    <h2>Zone administrative Techno Direct</h2>

    <div class="admin-section">
      <h3>üñºÔ∏è Gestion des affiches</h3>
      <div id="adminAffiches"></div>
      <div class="admin-controls">
        <button class="add" onclick="ajouterAffiche()">+ Ajouter une affiche</button>
        <button class="save" onclick="sauvegarderAffiches()">üíæ Sauvegarder</button>
      </div>
    </div>

    <div class="admin-section">
      <h3>üöö Tarifs de livraison par Wilaya</h3>
      <div id="adminLivraisons"></div>
      <div class="admin-controls">
        <button class="save" onclick="afficherLivraisonsAdmin()">üîÅ Rafra√Æchir</button>
        <button class="free" onclick="toggleLivraisonGratuite()">üöÄ Activer/D√©sactiver Livraison gratuite</button>
      </div>
    </div>

    <div class="admin-section">
      <h3>üì¶ Commandes re√ßues</h3>
      <div id="adminCommandes"></div>
      <div class="admin-controls">
        <button class="deleteAll" onclick="supprimerToutesCommandes()">üóëÔ∏è Tout supprimer</button>
      </div>
    </div>
  </div>

  <!-- ======== Pied de page ======== -->
  <footer>
    <p>üìû 0699039372 | 0560072059</p>
    <p>üì∑ Instagram : <a href="https://instagram.com/techno__direct" target="_blank">@techno__direct</a></p>
    <p>üìò Facebook : <a href="https://facebook.com/techno direct" target="_blank">techno direct</a></p>
  </footer>
<!-- üî∂ Fin de la partie 1 / 3 -->
<!-- ================== PARTIE 2 / 3 ================== -->
<!-- Zone admin : √©dition des affiches (upload image), gestion wilayas (2 prix), preview -->
<section id="adminControls" style="display:none;">
  <div style="max-width:1100px;margin:12px auto;padding:12px">
    <h2 style="color:#ff6b00;text-align:center;margin-bottom:12px">Administration ‚Äî Techno Direct</h2>

    <!-- ======== Gestion affiches (√©dition / ajout) ======== -->
    <div style="background:#fff;border-radius:10px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)">
      <h3 style="margin-bottom:8px;color:#ff6b00">üñºÔ∏è Affiches : Modifier / Ajouter</h3>

      <div id="adminFormContainer" style="display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start">
        <div>
          <label>Nom du produit</label>
          <input id="admin_nom_global" type="text" placeholder="Ex : HP ZBook 14u G6" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd">

          <label style="margin-top:8px">Prix (DA)</label>
          <input id="admin_prix_global" type="number" placeholder="ex : 60000" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd">

          <label style="margin-top:8px">Sp√©cifications courtes</label>
          <input id="admin_specs_global" type="text" placeholder="ex : 256 SSD ¬∑ 8 GigaOKT ¬∑ i5" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd">

          <label style="margin-top:8px">Description (d√©tails)</label>
          <textarea id="admin_desc_global" placeholder="Description d√©taill√©e" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd;min-height:90px"></textarea>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button onclick="adminAddOrUpdate()" class="admin-btn-save" style="background:#ff6b00;color:#fff;padding:10px;border-radius:8px;border:0;font-weight:700;cursor:pointer">üíæ Ajouter / Sauvegarder</button>
            <button onclick="adminClearForm()" style="background:#ccc;color:#000;padding:10px;border-radius:8px;border:0;font-weight:700;cursor:pointer">Annuler</button>
          </div>
        </div>

        <div style="background:#fafafa;padding:10px;border-radius:8px;border:1px solid #eee">
          <label>Image de l'affiche (t√©l√©charger depuis la galerie)</label>
          <input id="admin_image_file_global" type="file" accept="image/*" style="width:100%;margin-top:8px">
          <div id="admin_image_preview_global" style="margin-top:10px;border-radius:8px;overflow:hidden;background:#eee;min-height:140px;display:flex;align-items:center;justify-content:center">
            <span style="color:#999">Aucune image</span>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button onclick="removePreviewGlobal()" style="flex:1;background:#ef4444;color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer">Supprimer image</button>
            <button onclick="usePreviewAsNew()" style="flex:1;background:#25D366;color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer">Utiliser image</button>
          </div>
          <p style="font-size:12px;color:#777;margin-top:8px">Astuce : image max ~4.5MB. L'image est enregistr√©e en base64 dans le navigateur (localStorage).</p>
        </div>
      </div>

      <hr style="margin:14px 0;border:none;border-top:1px solid #f0f0f0">
      <div id="admin_list_container" style="margin-top:6px"></div>
    </div>

    <!-- ======== Tarifs de livraison par wilaya (Domicile / Bureau) ======== -->
    <div style="background:#fff;border-radius:10px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)">
      <h3 style="margin-bottom:8px;color:#ff6b00">üöö Tarifs de livraison ‚Äî 58 wilayas</h3>
      <p style="font-size:13px;color:#444;margin-bottom:8px">Saisis le prix pour <strong>Domicile</strong> et <strong>Bureau</strong>. Mets <strong>0</strong> si indisponible.</p>
      <div id="wilayaTable" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-height:440px;overflow:auto;padding:6px"></div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button onclick="saveWilayaPrices()" style="background:#ff6b00;color:#fff;padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:700">üíæ Sauvegarder tarifs</button>
        <button onclick="resetWilayaDefaults()" style="background:#ccc;color:#000;padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:700">R√©initialiser</button>
      </div>
    </div>

    <!-- ======== Commandes re√ßues (admin) ======== -->
    <div style="background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)">
      <h3 style="margin-bottom:8px;color:#ff6b00">üì¶ Commandes re√ßues</h3>
      <div id="admin_orders_list" style="max-height:360px;overflow:auto;padding:6px"></div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button onclick="exportOrdersCSV()" style="background:#25D366;color:#fff;padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:700">Exporter CSV</button>
        <button onclick="clearAllOrders()" style="background:#ef4444;color:#fff;padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:700">Supprimer toutes</button>
      </div>
    </div>
  </div>
</section>

<!-- ======= Pop-up confirmation ======= -->
<div id="confirmPopup" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:999">
  <div style="background:#fff;padding:18px;border-radius:8px;max-width:360px;text-align:center">
    <p id="confirmText">Confirmer ?</p>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="confirmYes()" style="flex:1;background:#ff6b00;color:#fff;padding:8px;border-radius:8px;border:0">Oui</button>
      <button onclick="confirmNo()" style="flex:1;background:#ccc;color:#000;padding:8px;border-radius:8px;border:0">Non</button>
    </div>
  </div>
</div>

<script>
  // Liste compl√®te des 58 wilayas d'Alg√©rie
  const WILAYAS_58 = [
    "Adrar","Chlef","Laghouat","Oum El Bouaghi","Batna","B√©ja√Øa","Biskra","B√©char","Blida","Bouira",
    "Tamanrasset","T√©bessa","Tlemcen","Tiaret","Tizi Ouzou","Alger","Djelfa","Jijel","S√©tif","Sa√Øda",
    "Skikda","Sidi Bel Abb√®s","Annaba","Guelma","Constantine","M√©d√©a","Mostaganem","M'Sila","Mascara","Ouargla",
    "Oran","El Bayadh","Illizi","Bordj Bou Arreridj","Boumerd√®s","El Tarf","Tindouf","Tissemsilt","El Oued","Khenchela",
    "Souk Ahras","Tipaza","Mila","A√Øn Defla","Na√¢ma","A√Øn T√©mouchent","Gharda√Øa","Relizane","Timimoun","Bordj Badji Mokhtar",
    "Ouled Djellal","B√©ni Abb√®s","In Salah","In Guezzam","Touggourt","Djanet","El M'Ghair","El Meniaa"
  ];

  function buildWilayaTable(pricesObj = {}) {
    const root = document.getElementById("wilayaTable");
    if(!root) return;
    root.innerHTML = "";
    WILAYAS_58.forEach(w => {
      const dom = pricesObj[w]?.domicile ?? "";
      const bur = pricesObj[w]?.bureau ?? "";
      const card = document.createElement("div");
      card.style.background = "#fafafa";
      card.style.padding = "8px";
      card.style.borderRadius = "8px";
      card.style.border = "1px solid #eee";
      card.innerHTML = `
        <div style="font-weight:700;color:#333;margin-bottom:6px">${w}</div>
        <div style="display:flex;gap:6px">
          <input data-wilaya="${w}" data-type="domicile" type="number" placeholder="Domicile" value="${dom}" style="flex:1;padding:6px;border-radius:6px;border:1px solid #ddd">
          <input data-wilaya="${w}" data-type="bureau" type="number" placeholder="Bureau" value="${bur}" style="flex:1;padding:6px;border-radius:6px;border:1px solid #ddd">
        </div>
      `;
      root.appendChild(card);
    });
  }

  // Placeholder des fonctions JS (r√©elles dans la partie 3)
  function adminAddOrUpdate(){ alert('Ajout / sauvegarde (Partie 3)'); }
  function adminClearForm(){ document.getElementById('admin_nom_global').value=''; document.getElementById('admin_prix_global').value=''; document.getElementById('admin_desc_global').value=''; document.getElementById('admin_specs_global').value=''; removePreviewGlobal(); }
  function removePreviewGlobal(){ const preview=document.getElementById("admin_image_preview_global"); preview.innerHTML='<span style="color:#999">Aucune image</span>'; delete preview.dataset.src; document.getElementById("admin_image_file_global").value=""; }
  function usePreviewAsNew(){ const p=document.getElementById("admin_image_preview_global"); if(p.dataset.src) alert("Image pr√™te √†

<script>
/* ===================== PARTIE 3 / 3 - LOGIC FINAL ===================== */

/*
  Cl√©s localStorage utilis√©es :
   - td_affiches  => liste d'affiches (objets {nom,prix,specs,desc,image,id})
   - td_commandes => liste des commandes
   - td_wilayas   => objet { "Wilaya": { domicile: <num>, bureau: <num> } }
   - td_livraison_gratuite => boolean
*/

/* ---------- UTIL ---------- */
function uid(){ return 'id'+Math.random().toString(36).slice(2,9) }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
function load(key){ try{ const v = localStorage.getItem(key); return v?JSON.parse(v):null }catch(e){return null} }
function fmt(n){ if(n==null) return '0'; return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,' '); }
function esc(s){ if(!s) return ''; return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;') }

/* ---------- DEFAULT DATA ---------- */
// If you had previous keys, we migrate them to td_affiches
let affiches = load('td_affiches') || load('td_affiches_v2') || [
  { id: uid(), nom: "HP ZBook 14u G6", prix: 60000, specs: "256 SSD ¬∑ 8 GigaOKT ¬∑ i5", desc: "Chargeur original, garantie.", image: "", },
  { id: uid(), nom: "Lenovo ThinkPad T480", prix: 72000, specs: "512 SSD ¬∑ 8 Go", desc: "Solide et rapide.", image: "", },
  { id: uid(), nom: "Dell Latitude 3310", prix: 65000, specs: "256 SSD ¬∑ 8 Go ¬∑ Full HD", desc: "Portable durable.", image: "", },
  { id: uid(), nom: "HP EliteBook 840 G3", prix: 58000, specs: "256 SSD ¬∑ 8 Go", desc: "L√©ger.", image: "", },
  { id: uid(), nom: "Lenovo IdeaPad 3", prix: 54000, specs: "128 SSD ¬∑ 4 Go", desc: "Bon rapport qualit√©/prix.", image: "", }
];

let commandes = load('td_commandes') || [];
let wilayaPrices = load('td_wilayas') || null;
let livraisonGratuite = load('td_livraison_gratuite') || false;

/* ---------- PRIX FOURNIS (ton tableau) ---------- */
/* J‚Äôai int√©gr√© les prix que tu m‚Äôas fournis, wilaya par wilaya (Domicile, Bureau).
   0 = indisponible pour ce type. Si une valeur est manquante on met 0. */
const DEFAULT_WILAYA_PRICES = {
  "Adrar": {domicile:1400, bureau:970},
  "Chlef": {domicile:800, bureau:520},
  "Laghouat": {domicile:950, bureau:620},
  "Oum El Bouaghi": {domicile:800, bureau:520},
  "Batna": {domicile:800, bureau:520},
  "B√©ja√Øa": {domicile:500, bureau:520},
  "Biskra": {domicile:950, bureau:620},
  "B√©char": {domicile:1100, bureau:720},
  "Blida": {domicile:750, bureau:470},
  "Bouira": {domicile:700, bureau:520},
  "Tamanrasset": {domicile:1600, bureau:1120},
  "T√©bessa": {domicile:800, bureau:520},
  "Tlemcen": {domicile:900, bureau:570},
  "Tiaret": {domicile:800, bureau:520},
  "Tizi Ouzou": {domicile:650, bureau:520},
  "Alger": {domicile:600, bureau:470},
  "Djelfa": {domicile:950, bureau:620},
  "Jijel": {domicile:700, bureau:520},
  "S√©tif": {domicile:750, bureau:520},
  "Sa√Øda": {domicile:800, bureau:570},
  "Skikda": {domicile:750, bureau:520},
  "Sidi Bel Abb√®s": {domicile:750, bureau:520},
  "Annaba": {domicile:800, bureau:520},
  "Guelma": {domicile:800, bureau:520},
  "Constantine": {domicile:750, bureau:520},
  "M√©d√©a": {domicile:750, bureau:520},
  "Mostaganem": {domicile:750, bureau:520},
  "M'Sila": {domicile:850, bureau:570},
  "Mascara": {domicile:750, bureau:520},
  "Ouargla": {domicile:1000, bureau:670},
  "Oran": {domicile:700, bureau:520},
  "El Bayadh": {domicile:1050, bureau:670},
  "Illizi": {domicile:0, bureau:0},
  "Bordj Bou Arreridj": {domicile:750, bureau:520},
  "Boumerd√®s": {domicile:750, bureau:520},
  "El Tarf": {domicile:850, bureau:520},
  "Tindouf": {domicile:0, bureau:0},
  "Tissemsilt": {domicile:800, bureau:520},
  "El Oued": {domicile:1000, bureau:670},
  "Khenchela": {domicile:800, bureau:0},
  "Souk Ahras": {domicile:800, bureau:520},
  "Tipaza": {domicile:750, bureau:520},
  "Mila": {domicile:750, bureau:520},
  "A√Øn Defla": {domicile:750, bureau:520},
  "Na√¢ma": {domicile:1100, bureau:670},
  "A√Øn T√©mouchent": {domicile:750, bureau:520},
  "Gharda√Øa": {domicile:1000, bureau:620},
  "Relizane": {domicile:750, bureau:520},
  "Timimoun": {domicile:1400, bureau:0},
  "Bordj Badji Mokhtar": {domicile:0, bureau:0},
  "Ouled Djellal": {domicile:950, bureau:620},
  "B√©ni Abb√®s": {domicile:1000, bureau:970},
  "In Salah": {domicile:1600, bureau:0},
  "In Guezzam": {domicile:1600, bureau:0},
  "Touggourt": {domicile:1000, bureau:670},
  "Djanet": {domicile:0, bureau:0},
  "El M'Ghair": {domicile:1000, bureau:0},
  "El Meniaa": {domicile:1000, bureau:0}
};

// If no saved wilayaPrices, use default
if(!wilayaPrices) {
  wilayaPrices = JSON.parse(JSON.stringify(DEFAULT_WILAYA_PRICES));
  save('td_wilayas', wilayaPrices);
}

/* ---------- RENDER PUBLIC AFFICHEs ---------- */
function renderPublicAffiches(){
  const root = document.getElementById('affichesContainer');
  if(!root) return;
  root.innerHTML = '';
  affiches.forEach((a, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    const imgUrl = a.image && a.image.length>10 ? a.image : 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=900&q=60';
    card.innerHTML = `
      <img src="${imgUrl}" alt="${esc(a.nom)}">
      <div class="info">
        <h3>${esc(a.nom)}</h3>
        <p>${esc(a.specs||a.desc||'')}</p>
        <p><strong>Prix :</strong> ${fmt(a.prix)} DA</p>
        ${livraisonGratuite ? `<p class="livraison-gratuite">üöö Livraison gratuite</p>` : `<p><strong>Livraison :</strong> Voir selon wilaya</p>`}
        <div class="buttons">
          <button onclick="openOrderPopup('${a.id}')">Commander ici</button>
          <a href="https://wa.me/213699039372?text=${encodeURIComponent('Salam, je veux commander '+a.nom)}" target="_blank">
            <button class="whatsapp">Commande WhatsApp</button>
          </a>
        </div>
      </div>
    `;
    root.appendChild(card);
  });
}

/* ---------- ORDER POPUP (public) ---------- */
let currentOrderProductId = null;
function openOrderPopup(productId){
  currentOrderProductId = productId;
  const product = affiches.find(x=>x.id===productId);
  if(!product) return alert("Produit introuvable.");
  // Create popup
  const popup = document.createElement('div');
  popup.className = 'form-popup';
  popup.id = 'orderPopup';
  popup.innerHTML = `
    <div class="form-content">
      <h2>Commander ‚Äî ${esc(product.nom)}</h2>
      <input id="order_nom" placeholder="Ton pr√©nom et nom" />
      <input id="order_tel" placeholder="Num√©ro principal" />
      <input id="order_tel2" placeholder="Num√©ro secondaire (facultatif)" />
      <select id="order_wilaya"><option value="">-- Choisir la wilaya --</option></select>
      <select id="order_type">
        <option value="Domicile">Livraison √† domicile</option>
        <option value="Bureau">R√©cup√©rer au bureau</option>
      </select>
      <div class="total-prix" id="order_total">Total estim√© : ${fmt(product.prix)} DA</div>
      <button id="order_submit">Commander</button>
      <button id="order_close" style="background:#ccc;color:#000;margin-top:6px">Fermer</button>
    </div>
  `;
  document.body.appendChild(popup);
  // fill wilaya select
  const sel = document.getElementById('order_wilaya');
  Object.keys(wilayaPrices).forEach(w=>{
    const opt = document.createElement('option');
    opt.value = w; opt.textContent = w;
    sel.appendChild(opt);
  });
  // attach events
  document.getElementById('order_wilaya').addEventListener('change', updateOrderTotal);
  document.getElementById('order_type').addEventListener('change', updateOrderTotal);
  document.getElementById('order_submit').addEventListener('click', submitOrder);
  document.getElementById('order_close').addEventListener('click', ()=>{ document.getElementById('orderPopup').remove(); });
  updateOrderTotal();
}

function updateOrderTotal(){
  const product = affiches.find(x=>x.id===currentOrderProductId);
  if(!product) return;
  const wil = document.getElementById('order_wilaya').value;
  const type = document.getElementById('order_type').value;
  const totalEl = document.getElementById('order_total');
  if(!wil){ totalEl.innerText = `Total estim√© : ${fmt(product.prix)} DA (choisis la wilaya pour voir la livraison)`; return; }
  const prices = wilayaPrices[wil] || {domicile:0,bureau:0};
  const prixType = type === 'Domicile' ? prices.domicile : prices.bureau;
  // Interpret availability rules:
  // - both 0 => livraison indisponible (ni domicile ni bureau)
  // - one of the two 0 => that type unavailable
  if(prices.domicile === 0 && prices.bureau === 0){
    totalEl.innerText = `Livraison indisponible pour ${wil}. Contacte-nous pour options.`;
    document.getElementById('order_submit').disabled = true;
    document.getElementById('order_submit').style.opacity = 0.5;
    return;
  }
  if(prixType === 0){
    // chosen type not available
    totalEl.innerText = `Mode ${type} non disponible pour ${wil}. Choisis l'autre mode.`;
    document.getElementById('order_submit').disabled = true;
    document.getElementById('order_submit').style.opacity = 0.5;
    return;
  }
  // else compute
  const livraison = livraisonGratuite ? 0 : prixType;
  const total = parseInt(product.prix) + parseInt(livraison);
  totalEl.innerText = `Total estim√© : ${fmt(product.prix)} + ${fmt(livraison)} DA = ${fmt(total)} DA`;
  document.getElementById('order_submit').disabled = false;
  document.getElementById('order_submit').style.opacity = 1;
}

function submitOrder(){
  const product = affiches.find(x=>x.id===currentOrderProductId);
  if(!product) return;
  const nom = document.getElementById('order_nom').value.trim();
  const tel = document.getElementById('order_tel').value.trim();
  const tel2 = document.getElementById('order_tel2').value.trim();
  const wil = document.getElementById('order_wilaya').value;
  const type = document.getElementById('order_type').value;
  if(!nom || !tel || !wil){ return alert("Remplis ton nom, t√©l√©phone et choisis la wilaya."); }
  const prices = wilayaPrices[wil] || {domicile:0,bureau:0};
  const prixType = type === 'Domicile' ? prices.domicile : prices.bureau;
  if(prixType === 0 && !(prices.domicile===0 && prices.bureau===0)){ return alert("Le mode de livraison choisi n'est pas disponible pour cette wilaya."); }
  if(prices.domicile===0 && prices.bureau===0){ return alert("La livraison n'est pas disponible pour cette wilaya."); }
  const livraison = livraisonGratuite ? 0 : prixType;
  const total = parseInt(product.prix) + parseInt(livraison);

  const cmd = {
    id: uid(),
    produitId: product.id,
    produit: product.nom,
    nom, tel, tel2, wilaya: wil, type, prixProduit: product.prix, prixLivraison: livraison, total,
    date: (new Date()).toISOString()
  };
  commandes.push(cmd);
  save('td_commandes', commandes);
  // refresh admin if open
  renderAdminOrders();
  alert("‚úÖ Commande enregistr√©e ! Nous te contacterons bient√¥t.");
  const popup = document.getElementById('orderPopup');
  if(popup) popup.remove();
}

/* ---------- ADMIN FUNCTIONS (implement placeholders from Part 2) ---------- */
let editingAdminIndex = -1;

function adminAddOrUpdate(){
  const nom = document.getElementById('admin_nom_global').value.trim();
  const prix = parseInt(document.getElementById('admin_prix_global').value) || 0;
  const specs = document.getElementById('admin_specs_global').value.trim();
  const desc = document.getElementById('admin_desc_global').value.trim();
  const preview = document.getElementById('admin_image_preview_global');
  const imageBase64 = preview && preview.dataset && preview.dataset.src ? preview.dataset.src : '';

  if(!nom || !prix || !desc){
    return alert("Nom, prix et description sont obligatoires.");
  }
  if(editingAdminIndex >= 0){
    // update existing
    affiches[editingAdminIndex].nom = nom;
    affiches[editingAdminIndex].prix = prix;
    affiches[editingAdminIndex].specs = specs;
    affiches[editingAdminIndex].desc = desc;
    if(imageBase64 && imageBase64.length>10) affiches[editingAdminIndex].image = imageBase64;
    save('td_affiches', affiches);
    editingAdminIndex = -1;
    alert("‚úÖ Affiche modifi√©e et sauvegard√©e.");
  } else {
    if(affiches.length >= 20) return alert("Limite 20 affiches atteinte.");
    const obj = { id: uid(), nom, prix, specs, desc, image: imageBase64 || "" };
    affiches.push(obj);
    save('td_affiches', affiches);
    alert("‚úÖ Nouvelle affiche ajout√©e.");
  }
  // reset form and re-render UI & public
  adminClearForm();
  renderAdminList();
  renderPublicAffiches();
  // update admin placements if visible
  try{ renderAdminList(); }catch(e){}
}

function adminClearForm(){
  document.getElementById('admin_nom_global').value = '';
  document.getElementById('admin_prix_global').value = '';
  document.getElementById('admin_specs_global').value = '';
  document.getElementById('admin_desc_global').value = '';
  removePreviewGlobal();
  editingAdminIndex = -1;
}

/* populate form for editing index i */
function adminPopulateEdit(i){
  if(!affiches[i]) return;
  editingAdminIndex = i;
  const a = affiches[i];
  document.getElementById('admin_nom_global').value = a.nom || '';
  document.getElementById('admin_prix_global').value = a.prix || '';
  document.getElementById('admin_specs_global').value = a.specs || '';
  document.getElementById('admin_desc_global').value = a.desc || '';
  const preview = document.getElementById('admin_image_preview_global');
  if(a.image && a.image.length>10){
    preview.innerHTML = `<img src="${a.image}" style="width:100%;height:auto;display:block" />`;
    preview.dataset.src = a.image;
  } else {
    preview.innerHTML = `<span style="color:#999">Aucune image</span>`;
    delete preview.dataset.src;
  }
  // scroll to form
  document.getElementById('adminFormContainer').scrollIntoView({behavior:'smooth'});
}

/* delete after confirm */
function adminDeleteConfirmed(i){
  affiches.splice(i,1);
  save('td_affiches', affiches);
  renderAdminList();
  renderPublicAffiches();
}

/* move up / down */
function adminMoveUp(i){
  if(i<=0) return;
  const t = affiches[i-1];
  affiches[i-1] = affiches[i];
  affiches[i] = t;
  save('td_affiches', affiches);
  renderAdminList();
  renderPublicAffiches();
}
function adminMoveDown(i){
  if(i>=affiches.length-1) return;
  const t = affiches[i+1];
  affiches[i+1] = affiches[i];
  affiches[i] = t;
  save('td_affiches', affiches);
  renderAdminList();
  renderPublicAffiches();
}

/* render admin list (used by Part 2 UI) */
function renderAdminList(){
  // use container id admin_list_container
  const root = document.getElementById('admin_list_container');
  if(!root) return;
  root.innerHTML = '';
  if(affiches.length === 0){
    root.innerHTML = '<p style="color:#666">Aucune affiche publi√©e ‚Äî ajoute la premi√®re !</p>';
    return;
  }
  affiches.forEach((a,i) => {
    const div = document.createElement('div');
    div.className = 'admin-affiche';
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:110px;height:70px;overflow:hidden;border-radius:8px;background:#f0f0f0">
          <img src="${a.image && a.image.length>10 ? a.image : 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=600&q=60'}" style="width:100%;height:100%;object-fit:cover" />
        </div>
        <div style="flex:1">
          <div style="font-weight:700;color:#ff6b00">${esc(a.nom)}</div>
          <div style="font-size:13px;color:#444">${esc(a.specs || '')}</div>
          <div style="margin-top:6px;font-weight:700">${a.prix ? fmt(a.prix)+' DA' : ''}</div>
          <div style="margin-top:8px;display:flex;gap:6px">
            <button onclick="adminPopulateEdit(${i})" style="background:#2d9cdb;color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer">Modifier</button>
            <button onclick="adminConfirmDelete(${i})" style="background:#ef4444;color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer">Suppr</button>
            <button onclick="adminMoveUp(${i})" style="background:#777;color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer">‚Üë</button>
            <button onclick="adminMoveDown(${i})" style="background:#777;color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer">‚Üì</button>
          </div>
        </div>
      </div>
    `;
    root.appendChild(div);
  });
}

/* Confirm delete wrapper used by Part 2 confirm popup */
function adminConfirmDelete(index){
  // reuse confirm popup
  document.getElementById('confirmText').innerText = "Supprimer cette affiche ?";
  document.getElementById('confirmPopup').style.display = 'flex';
  confirmCallbackYes = function(){ adminDeleteConfirmed(index); };
}

/* ---------- WILAYA PRICES: read/save/reset ---------- */
function saveWilayaPrices(){
  const inputs = document.querySelectorAll('#wilayaTable input[data-wilaya]');
  inputs.forEach(inp=>{
    const w = inp.dataset.wilaya;
    const t = inp.dataset.type; // domicile or bureau
    const v = parseInt(inp.value) || 0;
    if(!wilayaPrices[w]) wilayaPrices[w] = {domicile:0,bureau:0};
    wilayaPrices[w][t] = v;
  });
  save('td_wilayas', wilayaPrices);
  alert("‚úÖ Tarifs sauvegard√©s.");
}

function resetWilayaDefaults(){
  if(!confirm("R√©initialiser les tarifs par d√©faut fournis ?")) return;
  wilayaPrices = JSON.parse(JSON.stringify(DEFAULT_WILAYA_PRICES));
  save('td_wilayas', wilayaPrices);
  buildWilayaTable(wilayaPrices); // refresh UI from Part 2
  alert("‚úÖ Tarifs r√©initialis√©s.");
}

/* buildWilayaTable from Part 2 uses pricesObj; expose for initial load */
function buildWilayaTableWrapper(){
  // use the function provided in Part 2 if exists; else build here
  if(typeof buildWilayaTable === 'function') {
    buildWilayaTable(wilayaPrices);
    // After building, ensure inputs have dataset and onchange to update local object live
    const inputs = document.querySelectorAll('#wilayaTable input[data-wilaya]');
    inputs.forEach(inp=>{
      inp.addEventListener('change', (e)=> {
        const w = e.target.dataset.wilaya;
        const t = e.target.dataset.type;
        const v = parseInt(e.target.value) || 0;
        if(!wilayaPrices[w]) wilayaPrices[w] = {domicile:0,bureau:0};
        wilayaPrices[w][t]=v;
      });
    });
  } else {
    // fallback: recreate simple table
    // (shouldn't happen because Part 2 defined buildWilayaTable)
  }
}

/* ---------- COMMANDES ADMIN (render, delete, export) ---------- */
function renderAdminOrders(){
  const root = document.getElementById('admin_orders_list') || document.getElementById('adminCommandes') || document.getElementById('admin_table_commandes');
  if(!root) return;
  // unify rendering simple list
  const container = document.getElementById('admin_orders_list');
  if(container){
    container.innerHTML = '';
    if(commandes.length===0){ container.innerHTML = '<p style="color:#666">Aucune commande</p>'; return; }
    commandes.forEach((c,i)=>{
      const d = document.createElement('div');
      d.style.borderBottom = '1px solid #eee';
      d.style.padding = '8px 6px';
      d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">${esc(c.produit)} ‚Äî ${esc(c.nom)}</div>
          <div style="font-size:13px;color:#555">${esc(c.tel)}${c.tel2? ' / '+esc(c.tel2):''} ‚Äî ${esc(c.wilaya)} ‚Äî ${esc(c.type)}</div>
          <div style="margin-top:6px;font-weight:700">${fmt(c.total)} DA</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button onclick="openOrderWhatsApp(${i})" style="background:#25D366;color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer">WhatsApp</button>
          <button onclick="deleteOrder(${i})" style="background:#ef4444;color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer">Suppr</button>
        </div>
      </div>`;
      container.appendChild(d);
    });
    return;
  }

  // else if table version exists, populate
  if(root.tagName === 'TABLE') {
    // use table render from earlier
    let html = "<tr><th>Produit</th><th>Nom</th><th>T√©l</th><th>Wilaya</th><th>Type</th><th>Total</th><th>Actions</th></tr>";
    commandes.forEach((c,i)=>{
      html += `<tr>
        <td>${esc(c.produit)}</td>
        <td>${esc(c.nom)}</td>
        <td>${esc(c.tel)}${c.tel2 ? ' / '+esc(c.tel2) : ''}</td>
        <td>${esc(c.wilaya)}</td>
        <td>${esc(c.type)}</td>
        <td>${fmt(c.total)} DA</td>
        <td><button onclick="openOrderWhatsApp(${i})">WhatsApp</button> <button onclick="deleteOrder(${i})" style="background:#ef4444;color:#fff">Suppr</button></td>
      </tr>`;
    });
    root.innerHTML = html;
  }
}

function deleteOrder(i){
  if(!confirm("Supprimer cette commande ?")) return;
  commandes.splice(i,1);
  save('td_commandes', commandes);
  renderAdminOrders();
}

function clearAllOrders(){
  if(!confirm("Supprimer toutes les commandes ?")) return;
  commandes = [];
  save('td_commandes', commandes);
  renderAdminOrders();
}

function exportOrdersCSV(){
  if(commandes.length===0){ alert("Aucune commande √† exporter."); return; }
  const rows = [['id','produit','nom','tel','tel2','wilaya','type','prixProduit','prixLivraison','total','date']];
  commandes.forEach(c=>{
    rows.push([c.id,c.produit,c.nom,c.tel,c.tel2||'',c.wilaya,c.type,c.prixProduit,c.prixLivraison,c.total,c.date]);
  });
  const csv = rows.map(r => r.map(v => '"'+(''+(v||'')).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'commandes_techno_direct.csv'; document.body.appendChild(a); a.click(); a.remove();
}

/* open WhatsApp to contact about a specific order */
function openOrderWhatsApp(index){
  const c = commandes[index];
  if(!c) return;
  const msg = encodeURIComponent(`Salam, commande: ${c.produit}\nNom: ${c.nom}\nT√©l: ${c.tel}${c.tel2? ' / '+c.tel2 : ''}\nWilaya: ${c.wilaya}\nType: ${c.type}\nTotal: ${c.total} DA`);
  window.open(`https://wa.me/213699039372?text=${msg}`, '_blank');
}

/* ---------- IMAGE PREVIEW HANDLING (global file input) ---------- */
const globalFileInput = document.getElementById('admin_image_file_global');
if(globalFileInput){
  globalFileInput.addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    if(f.size > 4_500_000){ alert("Image trop lourde (max ~4.5MB)."); e.target.value=''; return; }
    const reader = new FileReader();
    reader.onload = function(evt){
      const preview = document.getElementById('admin_image_preview_global');
      preview.innerHTML = `<img src="${evt.target.result}" style="width:100%;height:auto;display:block" />`;
      preview.dataset.src = evt.target.result;
    };
    reader.readAsDataURL(f);
  });
}

/* ---------- ADMIN UI INITIALIZATION ---------- */
function openAdminControls(){
  // show both adminControls (Part 2) and #adminPanel if exists
  const a = document.getElementById('adminControls') || document.getElementById('adminPanel');
  if(a) a.style.display = 'block';
  // build wilaya table with current wilayaPrices (function from Part 2)
  buildWilayaTableWrapper();
  // render admin lists
  renderAdminList();
  renderAdminOrders();
  // scroll to top
  window.scrollTo({top:0,behavior:'smooth'});
}

// bind double-click on header (if not already bound)
try {
  const head = document.getElementById('siteHeader') || document.querySelector('header');
  if(head){
    head.ondblclick = function(){ const pwd = prompt("Mot de passe :"); if(pwd==='technoid'){ openAdminControls(); } else { alert("Mot de passe incorrect"); } };
  }
} catch(e){}

/* ---------- INITIAL RENDER ---------- */
renderPublicAffiches();
buildWilayaTableWrapper();
renderAdminList();
renderAdminOrders();

/* ---------- Confirm popup callback mechanism (from Part 2) ---------- */
let confirmCallbackYes = null;
function confirmYes(){ if(confirmCallbackYes) confirmCallbackYes(); document.getElementById('confirmPopup').style.display='none'; confirmCallbackYes=null; }
function confirmNo(){ document.getElementById('confirmPopup').style.display='none'; confirmCallbackYes=null; }

/* ---------- EXPORT API to global (used by inline onclicks) ---------- */
window.adminAddOrUpdate = adminAddOrUpdate;
window.adminClearForm = adminClearForm;
window.adminPopulateEdit = adminPopulateEdit;
window.adminDeleteConfirmed = adminDeleteConfirmed;
window.adminMoveUp = adminMoveUp;
window.adminMoveDown = adminMoveDown;
window.adminConfirmDelete = adminConfirmDelete;
window.saveWilayaPrices = saveWilayaPrices;
window.resetWilayaDefaults = resetWilayaDefaults;
window.exportOrdersCSV = exportOrdersCSV;
window.clearAllOrders = clearAllOrders;
window.openOrderPopup = openOrderPopup;
window.openAdminControls = openAdminControls;

/* ====================================================================== */
/* NOTE:
   - Le bouton "√©diter" public a bien √©t√© retir√© (les seules actions publiques
     sont Commander ici et WhatsApp).
   - Les images upload√©es depuis l'admin sont converties en base64 et stock√©es
     dans localStorage (cl√© td_affiches), ce qui permet l'affichage direct public.
   - Les prix envoy√©s par toi ont √©t√© int√©gr√©s dans DEFAULT_WILAYA_PRICES.
   - Si tu veux changer le mot de passe, je peux ajouter une option dans l'admin.
*/
/* ====================================================================== */

</script>
<!-- üî∂ Fin de la partie 3 / 3 -->
